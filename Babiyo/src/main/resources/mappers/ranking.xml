<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mealmaker.babiyo.ranking">

<select id="toDayList" resultType="productDto">
SELECT  NO, 
		COALESCE(R.NAME, '-') AS NAME
FROM(
	SELECT  NO, 
			NAME, 
			@RNUM:=@RNUM+1 AS RANKING
	FROM(
		SELECT  P.NO,
				P.NAME, 
				COUNT(*) COUNT
		FROM ORDER_DETAIL D JOIN MEMBER_ORDER O
		ON D.ORDER_NO = O.NO
		JOIN PRODUCT P
		ON D.PRODUCT_NO = P.NO
		WHERE O.ORDER_DATE >= DATE_SUB(NOW(), INTERVAL 1 DAY)
		AND O.STATE_CODE = 2
		GROUP BY D.PRODUCT_NO, 
				 P.NAME, 
				 P.NO
		HAVING COUNT(*) > 0
		ORDER BY COUNT
	) AS OD,
	(SELECT @RNUM:=0) AS RN
) AS R RIGHT OUTER JOIN(
	SELECT 1 "RANKING" FROM DUAL
	UNION ALL
	SELECT 2 FROM DUAL
	UNION ALL
	SELECT 3 FROM DUAL
	UNION ALL
	SELECT 4 FROM DUAL
	UNION ALL
	SELECT 5 FROM DUAL
) AS S
ON R.RANKING = S.RANKING
ORDER BY S.RANKING
</select>

<select id="weeklyList" resultType="productDto">
SELECT  NO, 
		COALESCE(R.NAME, '-') NAME
FROM(
	SELECT  NO, 
			NAME, 
			@RNUM:=@RNUM+1 RANKING
	FROM(
		SELECT  P.NO, 
				P.NAME , 
				COUNT(*) COUNT
		FROM ORDER_DETAIL D JOIN MEMBER_ORDER O
		ON D.ORDER_NO = O.NO
		JOIN PRODUCT P
		ON D.PRODUCT_NO = P.NO
		WHERE O.ORDER_DATE >= DATE_SUB(NOW(), INTERVAL 7 DAY)
		AND O.STATE_CODE = 2
		GROUP BY D.PRODUCT_NO, 
				 P.NAME, 
				 P.NO
		HAVING COUNT(*) > 0
		ORDER BY COUNT
	) AS OD,
	(SELECT @RNUM:=0) AS RN
) AS R RIGHT OUTER JOIN(
	SELECT 1 "RANKING" FROM DUAL
	UNION ALL
	SELECT 2 FROM DUAL
	UNION ALL
	SELECT 3 FROM DUAL
	UNION ALL
	SELECT 4 FROM DUAL
	UNION ALL
	SELECT 5 FROM DUAL
) AS S
ON R.RANKING = S.RANKING
ORDER BY S.RANKING
</select>

<select id="manList" resultType="productDto">
SELECT 	NO, 
		COALESCE(R.NAME, '-') NAME
FROM(
	SELECT  NO, 
			NAME, 
			@RNUM:=@RNUM+1 AS RANKING
	FROM(
		SELECT  P.NO, 
				P.NAME,
				COUNT(*) COUNT
		FROM ORDER_DETAIL D JOIN MEMBER_ORDER O
		ON D.ORDER_NO = O.NO
		JOIN PRODUCT P
		ON D.PRODUCT_NO = P.NO
		JOIN MEMBERS M
		ON O.MEMBER_ID = M.ID
		WHERE M.GENDER = '남'
		AND O.STATE_CODE = 2
		GROUP BY D.PRODUCT_NO, 
				 P.NAME, 
				 P.NO
		HAVING COUNT(*) > 0
		ORDER BY COUNT
	) AS OD,
	(SELECT @RNUM:=0) AS RN
) AS R RIGHT OUTER JOIN(
	SELECT 1 "RANKING" FROM DUAL
	UNION ALL
	SELECT 2 FROM DUAL
	UNION ALL
	SELECT 3 FROM DUAL
	UNION ALL
	SELECT 4 FROM DUAL
	UNION ALL
	SELECT 5 FROM DUAL
) AS S
ON R.RANKING = S.RANKING
ORDER BY S.RANKING
</select>

<select id="womanList" resultType="productDto">
SELECT NO, 
	   COALESCE(R.NAME, '-') NAME
FROM(
	SELECT NO, 
		   NAME, 
		   @RNUM:=@RNUM+1 AS RANKING
	FROM(
		SELECT P.NO, 
			   P.NAME, 
			   COUNT(*) COUNT
		FROM ORDER_DETAIL D JOIN MEMBER_ORDER O
		ON D.ORDER_NO = O.NO
		JOIN PRODUCT P
		ON D.PRODUCT_NO = P.NO
		JOIN MEMBERS M
		ON O.MEMBER_ID = M.ID
		WHERE M.GENDER = '여'
		AND O.STATE_CODE = 2
		GROUP BY D.PRODUCT_NO, 
				 P.NAME, 
				 P.NO
		HAVING COUNT(*) > 0
		ORDER BY COUNT
	) AS OD,
	(SELECT @RNUM:=0) AS RN
) R RIGHT OUTER JOIN(
	SELECT 1 "RANKING" FROM DUAL
	UNION ALL
	SELECT 2 FROM DUAL
	UNION ALL
	SELECT 3 FROM DUAL
	UNION ALL
	SELECT 4 FROM DUAL
	UNION ALL
	SELECT 5 FROM DUAL
) AS S
ON R.RANKING = S.RANKING
ORDER BY S.RANKING
</select>


</mapper>